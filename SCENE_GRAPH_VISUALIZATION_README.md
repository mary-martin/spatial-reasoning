# Scene Graph Visualization with Referent Highlighting

This repository contains tools for visualizing scene graphs and highlighting referent objects based on referring expressions generated by the CLEVR-Ref+ pipeline.

## Overview

The visualization tools help you understand:
- How objects in a scene are connected through spatial relationships
- Which objects are identified as referents by different referring expressions
- The structure of scene graphs with objects as nodes and relationships as edges
- How different referring expressions can identify different objects in the same scene

## Files

### Core Visualization Scripts

1. **`visualize_scene_graph_with_referent.py`** - Main visualization script
   - Creates a single visualization showing a scene graph with one referring expression
   - Highlights the referent object(s) in red
   - Shows object properties and spatial relationships

2. **`batch_visualize_scene_graphs.py`** - Batch visualization script
   - Creates multiple visualizations for different referring expressions in the same scene
   - Shows how different expressions identify different objects
   - Useful for comparing multiple referring expressions

3. **`demo_scene_graph_visualization.py`** - Demo script
   - Runs example visualizations to demonstrate the tools
   - Creates sample output files
   - Shows usage examples

## Usage

### Prerequisites

Make sure you have the required data files:
- Scene data: `custom_clevr/output/clevr_ref+_scenes.json`
- Referring expressions: `custom_clevr/output/clevr_ref+_refexps_full_examples.json`

### Basic Usage

#### Single Referring Expression Visualization

```bash
python visualize_scene_graph_with_referent.py \
  --scene_file custom_clevr/output/clevr_ref+_scenes.json \
  --refexp_file custom_clevr/output/clevr_ref+_refexps_full_examples.json \
  --scene_idx 0 \
  --refexp_idx 0
```

#### Batch Visualization (Multiple Referring Expressions)

```bash
python batch_visualize_scene_graphs.py \
  --scene_file custom_clevr/output/clevr_ref+_scenes.json \
  --refexp_file custom_clevr/output/clevr_ref+_refexps_full_examples.json \
  --scene_idx 0 \
  --max_refexps 6
```

#### Save Visualizations

```bash
# Save single visualization
python visualize_scene_graph_with_referent.py \
  --scene_file custom_clevr/output/clevr_ref+_scenes.json \
  --refexp_file custom_clevr/output/clevr_ref+_refexps_full_examples.json \
  --scene_idx 0 --refexp_idx 0 \
  --save_path my_visualization.png

# Save batch visualization
python batch_visualize_scene_graphs.py \
  --scene_file custom_clevr/output/clevr_ref+_scenes.json \
  --refexp_file custom_clevr/output/clevr_ref+_refexps_full_examples.json \
  --scene_idx 0 --max_refexps 4 \
  --save_path my_batch_visualization.png
```

### Command Line Arguments

#### `visualize_scene_graph_with_referent.py`

- `--scene_file`: Path to scene JSON file (required)
- `--refexp_file`: Path to referring expressions JSON file (required)
- `--scene_idx`: Index of scene to visualize (default: 0)
- `--refexp_idx`: Index of referring expression to use (default: 0)
- `--save_path`: Path to save the visualization (optional)
- `--no_show`: Do not display the plot (useful when saving)

#### `batch_visualize_scene_graphs.py`

- `--scene_file`: Path to scene JSON file (required)
- `--refexp_file`: Path to referring expressions JSON file (required)
- `--scene_idx`: Index of scene to visualize (default: 0)
- `--max_refexps`: Maximum number of referring expressions to show (default: 6)
- `--save_path`: Path to save the visualization (optional)
- `--no_show`: Do not display the plot (useful when saving)

## Understanding the Visualizations

### Scene Graph Structure

- **Nodes**: Represent objects in the scene
  - Node labels show: color, shape, and object index
  - Red nodes: Referent objects (identified by the referring expression)
  - Light blue nodes: Other objects in the scene

- **Edges**: Represent spatial relationships
  - Directed edges show relationships like "left", "right", "front", "behind"
  - Edge labels indicate the relationship type
  - Multiple edges can exist between the same objects (different relationship types)

### Object Information

Each visualization includes:
- Object properties: color, shape, size, material
- 3D coordinates of objects
- Spatial relationships between objects
- The referring expression text
- Which object(s) are identified as referents

### Example Output

The visualizations show:
1. **Scene Graph**: Network diagram with objects as nodes and relationships as edges
2. **Object Information Panel**: Detailed information about all objects and the referring expression
3. **Referent Highlighting**: Clear indication of which objects are the referents

## Running the Demo

To see the tools in action:

```bash
python demo_scene_graph_visualization.py
```

This will:
- Create example visualizations
- Show different referring expressions for the same scene
- Demonstrate batch visualization
- Generate sample output files

## Technical Details

### Scene Graph Creation

The tools create NetworkX directed graphs from scene data:
- Objects become nodes with attributes (color, shape, size, material, coordinates)
- Spatial relationships become directed edges with labels
- Handles complex relationship structures including nested lists (e.g., "between" relationships)

### Referring Expression Execution

The tools execute referring expression programs to find referents:
- Uses the `refexp_engine` module to execute programs
- Handles different result types (single objects, multiple objects, invalid results)
- Converts between different program formats (`program` vs `nodes`)

### Visualization Features

- **Consistent Layout**: Uses spring layout with fixed seed for reproducible positioning
- **Color Coding**: Red for referents, light blue for other objects
- **Edge Labels**: Show relationship types on edges
- **Object Labels**: Abbreviated object information on nodes
- **Information Panels**: Detailed object and expression information

## Integration with CLEVR-Ref+ Pipeline

These visualization tools are designed to work with:
- Scene data generated by the CLEVR-Ref+ image generation pipeline
- Referring expressions generated by the refexp generation pipeline
- The existing `Scene_Objects` class and `refexp_engine` module

## Troubleshooting

### Common Issues

1. **File not found errors**: Make sure the scene and referring expression files exist
2. **Index out of range**: Check that the scene_idx and refexp_idx are valid
3. **Import errors**: Ensure you're running from the correct directory with proper Python path

### Debugging

- Use `--no_show` flag when saving to avoid display issues
- Check that the referring expression files contain valid program structures
- Verify that scene data includes both objects and relationships

## Examples

### Example 1: Simple Referring Expression

```bash
# Visualize "the red cube" referring expression
python visualize_scene_graph_with_referent.py \
  --scene_file custom_clevr/output/clevr_ref+_scenes.json \
  --refexp_file custom_clevr/output/clevr_ref+_refexps_full_examples.json \
  --scene_idx 0 --refexp_idx 0
```

### Example 2: Complex Spatial Relationship

```bash
# Visualize "the object to the left of the blue sphere" referring expression
python visualize_scene_graph_with_referent.py \
  --scene_file custom_clevr/output/clevr_ref+_scenes.json \
  --refexp_file custom_clevr/output/clevr_ref+_refexps_full_examples.json \
  --scene_idx 0 --refexp_idx 5
```

### Example 3: Compare Multiple Expressions

```bash
# Show 6 different referring expressions for the same scene
python batch_visualize_scene_graphs.py \
  --scene_file custom_clevr/output/clevr_ref+_scenes.json \
  --refexp_file custom_clevr/output/clevr_ref+_refexps_full_examples.json \
  --scene_idx 0 --max_refexps 6 \
  --save_path comparison_visualization.png
```


